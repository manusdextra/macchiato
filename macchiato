#!/bin/sh
#
# macchiato - batch marking utility

usage () {
    cat <<EOF
Usage:
        macchiato key file...

Dependencies:
        python-docx2txt
EOF
    exit 1
}

bail () {
    printf "Error:\t$*"
    exit 1
}

# process arguments
[ $# -lt 2 ] && usage
if [ -e $1 ]; then 
    key="$1"
    shift
else
    bail "Answer key not found\n"
fi

# set up directories & records
processed="./processed"
[ -e $processed ] || mkdir $processed
outfile="./marks"
[ -e $outfile ] && cp "$outfile" "${outfile}-old"
printf "" > $outfile

for file in "$@"; do
    basename=${file##*/}
    # convert from different formats to plaintext
    case $file in
        *.docx)
            stem=${basename%%.docx}
            docx2txt "$file" "$processed/$stem"
        ;;
        *)
            printf "%s\n" "hello"
            cp "$file" "$processed/$basename"
        ;;
    esac
    #TODO clean up with sed
done

for file in $processed/*; do
    mistakes=$(diff -y --suppress-common-lines "$key" "$file" | wc -l)
    printf "%s %s\n" "$file" "$mistakes" >> "$outfile"
done
